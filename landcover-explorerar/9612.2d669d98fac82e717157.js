"use strict";(self.webpackChunkimagery_explorer_apps=self.webpackChunkimagery_explorer_apps||[]).push([[9612],{60814:function(e,t,n){n.d(t,{bU:function(){return M},fC:function(){return L},ir:function(){return f},zp:function(){return m}});n(39994);var i=n(19431),r=n(91772),o=n(89542),a=n(14685),s=n(14260),l=n(12065),u=n(15540),h=n(66069);const p=new Float64Array(2),c=new Float64Array(2),d="0123456789bcdefghjkmnpqrstuvwxyz",y=64;function f(e,t,n,i){const s=[e.xmin,e.ymin,e.xmax,e.ymax],p=o.Z.fromExtent(r.Z.fromBounds(s,i)),c=(0,h.iV)(p,i,a.Z.WGS84,{densificationStep:t*y});if(!c)return null;const d=(0,l.Uy)(new u.Z,c,!1,!1),f=d.coords.filter(((e,t)=>!(t%2))),g=d.coords.filter(((e,t)=>t%2)),b=Math.min(...f),C=Math.min(...g),T=Math.max(...f),w=Math.max(...g),M=m(b,C,n,a.Z.WGS84),k=m(T,w,n,a.Z.WGS84);return M&&k?{bounds:s,geohashBounds:{xLL:M[0],yLL:M[1],xTR:k[0],yTR:k[1]},level:n}:null}function m(e,t,n,r){if(r.isWebMercator){const r=(0,i.BV)(e/s.sv.radius),o=r-360*Math.floor((r+180)/360),a=[0,0];return k(a,0,(0,i.BV)(Math.PI/2-2*Math.atan(Math.exp(-t/s.sv.radius))),o,n),a}const o=(0,h.iV)({x:e,y:t},r,a.Z.WGS84);if(!o)return null;const l=[0,0];return k(l,0,o.y,o.x,n),l}function g(e){return d[e]}function b(e){return(e[0]+e[1])/2}function C(e,t,n){return e[0]=t,e[1]=n,e}function T(e,t){const n=b(e),i=t,r=!t;e[0]=r*e[0]+i*n,e[1]=r*n+i*e[1]}function w(e,t){const n=t>b(e);return T(e,n),n}function M(e,t){let n=-90,i=90,r=-180,o=180;for(let a=0;a<t;a++){const t=Math.ceil((a+1)/2),s=Math.floor((a+1)/2),l=1-a%2,u=30-(3*t+2*s),h=30-(2*t+3*s),p=3*l+2*(1-l),c=2*l+3*(1-l),d=3*l+7*(1-l)<<h,y=(7*l+3*(1-l)<<u&e.geohashX)>>u,f=(d&e.geohashY)>>h;for(let e=p-1;e>=0;e--){const t=(r+o)/2,n=y&1<<e?1:0;r=(1-n)*r+n*t,o=(1-n)*t+n*o}for(let e=c-1;e>=0;e--){const t=(n+i)/2,r=f&1<<e?1:0;n=(1-r)*n+r*t,i=(1-r)*t+r*i}}return[r,n,o,i]}function k(e,t,n,i,r){r%2&&(r+=1);let o=0,a=0,s=-90,l=90,u=-180,h=180;for(let e=0;e<r/2;e++){for(let t=0;t<5;t++){const n=(u+h)/2,r=i>n?1:0;o|=r<<29-(t+5*e),u=(1-r)*u+r*n,h=(1-r)*n+r*h}for(let t=0;t<5;t++){const i=(s+l)/2,r=n>i?1:0;a|=r<<29-(t+5*e),s=(1-r)*s+r*i,l=(1-r)*i+r*l}}e[2*t]=o,e[2*t+1]=a}function L(e,t,n){let i="";const r=C(p,-90,90),o=C(c,-180,180);for(let a=0;a<n;a++){let n=0;a%2?(n|=w(r,e)<<4,n|=w(o,t)<<3,n|=w(r,e)<<2,n|=w(o,t)<<1,n|=w(r,e)<<0):(n|=w(o,t)<<4,n|=w(r,e)<<3,n|=w(o,t)<<2,n|=w(r,e)<<1,n|=w(o,t)<<0),i+=g(n)}return i}},69195:function(e,t,n){n.r(t),n.d(t,{default:function(){return Ne}});var i=n(36663),r=(n(91957),n(6865)),o=n(70375),a=n(13802),s=n(78668),l=n(81977),u=(n(39994),n(4157),n(40266)),h=n(60814),p=n(38481),c=n(12065),d=n(15540),y=n(74396),f=n(86114),m=n(84684),g=n(89542),b=n(28105),C=n(35925),T=n(59958),w=n(53736);class M{constructor(){this._featureLookup=new Map}static getInstance(){return M.instance||(M.instance=new M),M.instance}static resetInstance(){M.instance&&(M.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const n=this.readFromStoreById(e);n&&t.push(n)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,n){const i=[];return e.forEach((e=>{if(!e?.id)return;e.properties||(e.properties=[]);let r,o=null;if(n&&e.properties[n]&&(o=(0,c.GH)(e.properties[n])),"originId"in e&&"destinationId"in e&&(e.properties.ESRI__ORIGIN_ID=e.originId,e.properties.ESRI__DESTINATION_ID=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){const i=this._featureLookup.get(e.id),a=JSON.parse(JSON.stringify(Object.assign(i.attributes,e.properties)));n&&e.properties[n]&&(a[n]=(0,w.im)(e.properties[n])),r=new T.u_(o?JSON.parse(JSON.stringify(o)):i?.geometry?JSON.parse(JSON.stringify(i.geometry)):null,a,null,e.properties[t])}else r=new T.u_(o?JSON.parse(JSON.stringify(o)):null,e.properties,null,e.properties[t]);this._featureLookup.set(e.id,r),i.push(r)})),i}}n(66341);var k,L=n(41350),I=n(76512);n(14685);!function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"}(k||(k={}));k.ELEMENTUID,k.TYPENAME;var E,x;!function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(E||(E={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(x||(x={}));var _,N,D,v;n(65726),n(79458);function R(e){if(!e.spatialReference.isWGS84)throw new o.Z("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let t;return t=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],t}!function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"}(_||(_={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(N||(N={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(D||(D={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(v||(v={}));var G=n(14136),S=n(91772);const Z="ESRI__ID",A="ESRI__ORIGIN_ID",F="ESRI__DESTINATION_ID",j="ESRI__LAYOUT_GEOMETRY",P="ESRI__AGGREGATION_COUNT",q=12;let O=class extends y.Z{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((n=>{n.name&&(t.set(n.name,"entity"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(n.name),n.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(n.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((n=>{n.name&&(t.set(n.name,"relationship"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(n.name),n.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(n.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((n,i)=>{if("entity"===t.get(i))this.entityTypeNames.add(i);else{if("relationship"!==t.get(i))return a.Z.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(i);this.relationshipTypeNames.add(i)}const r=new Map;n.members?.forEach((e=>{(0,f.s1)(this.memberIdTypeLookup,e.id,(()=>new Set)).add(i);const t=this.getById(e.id);t&&r.set(e.id,t)})),this.sublayerCaches.set(i,r)}))}addToLayer(e){e.forEach((({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new o.Z("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);n.members||(n.members=new Map),n.members.set(t,{id:t}),(0,f.s1)(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}else{const n=new Map;n.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),(0,f.s1)(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}))}getById(e){return M.getInstance().readFromStoreById(e)}async getData(e,t,n){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let i;if(i=e||new G.Z({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(t.objectType.name??""),r=i.outFields,o=i.geometry;let a="",s="";o&&o.extent&&(a=(0,h.fC)(o.extent.ymin,o.extent.xmin,q),s=(0,h.fC)(o.extent.ymax,o.extent.xmax,q)),r&&1===r.length&&r[0]===Z&&"1=1"===i.where||await Promise.all(n??[]);const l=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],u=[];return l.forEach((n=>{if(this.relationshipTypeNames.has(t.objectType.name)?n.geometry=e.relationshipLinkChartDiagramLookup.get(n.attributes[t.objectIdField]):n.geometry=e.entityLinkChartDiagramLookup.get(n.attributes[t.objectIdField]),n.attributes[j]=n.geometry,a&&s){const i=e.linkChartGeohashLookup.get(n.attributes[t.objectIdField]);i?i>=a&&i<=s&&u.push(n):u.push(n)}else u.push(n)})),u}return this.retrieveDataFromService(i,t,n)}async getConnectedRecordIds(e,t){const n=[];let i="";const r=[],o=new Map;if(e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(t))return;o.has(t)?o.get(t)?.push(e):o.set(t,[e])}})),t&&0!==t?.length){for(const e of t)i=i+e+"|";i=i.slice(0,-1)}return o.forEach(((e,o)=>{let s;s=t&&0!==t?.length?`MATCH (n:${o})-[r:${i}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${o})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const l=new Promise((t=>{(async()=>{const t=(await(0,L.executeQueryStreaming)(this.knowledgeGraph,new I.Z({openCypherQuery:s,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:i}=await t.read();if(e)break;for(let e=0;e<i.length;e++){const t=i[e];n.push({id:t[0],typeName:t[1]}),n.push({id:t[2],typeName:t[3]})}}}catch(e){if("AbortError"!==e.name)throw e;a.Z.getLogger(this).info("Request aborted as expected")}})().then((()=>{t()}))}));r.push(l)})),this.refreshCacheContent(),await Promise.all(r),n}async refreshCacheContent(e,t,n,i=!0){const r=M.getInstance(),a=[],s=new Map,l=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e))s.has(t)?s.get(t)?.push(e):s.set(t,[e])})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?s.set(t,null):e.members&&e.members.forEach((e=>{s.has(t)&&null!==s.get(t)?s.get(t)?.push(e.id):s.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&s.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&s.set(e.name,null)})));for(const[e,u]of s){const s=new Promise((a=>{(async()=>{const a=new Set,s=[];let h,p="",c=!1;if(t||l.get(e)?.properties?.forEach((e=>{e.name&&a.add(e.name)})),n&&this.geographicLookup.has(e)){const t=this.geographicLookup.get(e)?.name;t&&a.add(t)}if(this.entityTypeNames.has(e))p=`MATCH (n:${e}) ${u?"WHERE id(n) IN $ids ":""}return ID(n)`,a.forEach((e=>{p+=`, n.${e}`,s.push(e)}));else{if(!this.relationshipTypeNames.has(e))throw new o.Z("knowledge-graph:layer-data-manager",`The graph type of ${e} could not be determined. Was this type set in the KG data model and inclusion definition?`);c=!0,p=`MATCH ()-[n:${e}]->() ${u?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,a.forEach((e=>{p+=`, n.${e}`,s.push(e)}))}h=new I.Z(u?{openCypherQuery:p,bindParameters:{ids:u}}:{openCypherQuery:p});const d=(await(0,L.executeQueryStreaming)(this.knowledgeGraph,h)).resultRowsStream.getReader();for(;;){const{done:t,value:n}=await d.read();if(t)break;const o=[];for(let e=0;e<n.length;e++){const t=n[e];let i=0,r=0;const a={properties:{}};for(a.id=t[i],i++,r++,c&&(a.originId=t[i],i++,r++,a.destinationId=t[i],i++,r++,(0,f.s1)(this.nodeConnectionsLookup,a.originId,(()=>new Set)).add(a.id),(0,f.s1)(this.nodeConnectionsLookup,a.destinationId,(()=>new Set)).add(a.id),(0,f.s1)(this.relationshipConnectionsLookup,a.id,(()=>[a.originId,a.destinationId])));i<t.length;i++)a.properties[s[i-r]]=t[i];o.push(a)}const a=r.writeToStore(o,Z,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(e)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(e).members=new Map);const l=this.sublayerCaches.get(e);a.forEach((t=>{l?.set(t.attributes[Z],t),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.has(t.attributes[Z])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.set(t.attributes[Z],{id:t.attributes[Z]}),(0,f.s1)(this.memberIdTypeLookup,t.attributes[Z],(()=>new Set)).add(e))}))}})().then((()=>{a(null)}))}));a.push(s),this._processingCacheUpdatesLookup.get(e)?.push(s)}await Promise.all(a)}removeFromLayer(e){const t=new Set,n=new Set(e.map((e=>e.id)));for(const n of e)t.add(n.typeName),1===this.memberIdTypeLookup.get(n.id)?.size?this.memberIdTypeLookup.delete(n.id):this.memberIdTypeLookup.get(n.id)?.delete(n.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{t===n.typeName&&e.members?.has(n.id)&&e.members.delete(n.id)}));t.forEach((e=>{this.sublayerCaches.get(e)?.forEach(((t,i)=>{n.has(i)&&this.sublayerCaches.get(e)?.delete(i)}))}))}async retrieveDataFromService(e,t,n){const i=M.getInstance(),r=new Set,a=[];let s,l="",u=[];const h="relationship"===t.graphType,p=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,c=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let d=!p&&c?Array.from(c).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&null!=e.objectIds&&(d=e.objectIds);else if(null!=e.objectIds&&d&&d.length>0){const t=e.objectIds;e.objectIds=d.filter((e=>t.includes(e)))}else if(null!=e.objectIds)d=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=d}if(null!=e.outFields){const n=e.outFields;n.includes("*")?t.fields.forEach((e=>{r.add(e.name)})):n.forEach((e=>{e!==Z&&e!==t.geometryFieldName&&r.add(e)}))}if(null!=e.geometry){const n=e.geometry;let i;const u=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,p=u?.spatialReference,c=u?.serviceCapabilities?.geometryCapabilities;let d=c?.geometryMaxBoundingRectangleSizeX,y=c?.geometryMaxBoundingRectangleSizeY;if(n?.extent?.spatialReference&&!n.spatialReference?.isWGS84?(await(0,b.initializeProjection)(n.extent.spatialReference,C.YU),i=(0,b.project)(n.extent,C.YU)):i=n.extent,d&&y&&p){if(4326!==p.wkid){const e=new S.Z({spatialReference:p,xmax:d,ymax:y}),t=(0,b.project)(e,C.YU);d=t.xmax,y=t.ymax}if(i.xmax-i.xmin>d)throw new o.Z("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${d}° latitude, limit exceeded`);if(i.ymax-i.ymin>y)throw new o.Z("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${y}° longitude, limit exceeded`)}if(null!=e.where&&"1=1"!==e.where){const n=await(0,m.E)(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&r.add(e.name)}))}l=h?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach((e=>{l+=`, n.${e}`,a.push(e)})),s=new I.Z({openCypherQuery:l,bindParameters:{param_filter_geom:new g.Z({rings:R(i)})}})}else{let n="";if(null!=e.where&&"1=1"!==e.where){const i=await(0,m.E)(e.where,t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&r.add(e.name)}));const o=new Set(["column-reference","string","number","binary-expression"]),a=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let s=!1;const l=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&o.has(e.left.type)&&o.has(e.right.type)&&a.has(e.operator))return`${l(e.left)} ${e.operator} ${l(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return s=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return s=!0,"";{let n=e.right.value;"%"===n.charAt(0)&&(n=n.slice(1)),"%"===n.charAt(n.length-1)&&(n=n.slice(0,-1)),t+=`'${n.toLowerCase()}')`}return t}return s=!0,""};n=l(i.parseTree),s&&(n="")}let i="";i=h?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let o=!1;d&&(o=!0,i+=" WHERE ID(n) IN $ids"),n&&(i+=o?" AND":" WHERE",i+=` ${n}`),i+=" return ID(n)",h&&(i+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach((e=>{i+=`, n.${e}`,a.push(e)})),s=new I.Z(d?{openCypherQuery:i,bindParameters:{ids:d}}:{openCypherQuery:i})}const y=(await(0,L.executeQueryStreaming)(t.parentCompositeLayer.dataManager.knowledgeGraph,s,n)).resultRowsStream.getReader();for(;;){const{done:e,value:n}=await y.read();if(e)break;const r=[];for(let e=0;e<n.length;e++){const t=n[e];let i=0,o=0;const s={properties:{}};for(s.id=t[i],i++,o++,h&&(s.originId=t[i],i++,o++,s.destinationId=t[i],i++,o++);i<t.length;i++)s.properties[a[i-o]]=t[i];r.push(s)}u=u.concat(i.writeToStore(r,Z,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return u}};(0,i._)([(0,l.Cb)()],O.prototype,"knowledgeGraph",void 0),(0,i._)([(0,l.Cb)()],O.prototype,"inclusionModeDefinition",void 0),(0,i._)([(0,l.Cb)()],O.prototype,"entityTypeNames",void 0),(0,i._)([(0,l.Cb)()],O.prototype,"relationshipTypeNames",void 0),(0,i._)([(0,l.Cb)()],O.prototype,"geographicLookup",void 0),(0,i._)([(0,l.Cb)()],O.prototype,"sublayerCaches",void 0),(0,i._)([(0,l.Cb)()],O.prototype,"nodeConnectionsLookup",void 0),(0,i._)([(0,l.Cb)()],O.prototype,"relationshipConnectionsLookup",void 0),(0,i._)([(0,l.Cb)()],O.prototype,"memberIdTypeLookup",void 0),O=(0,i._)([(0,u.j)("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],O);var U=n(80020),B=(n(86004),n(55565),n(16192),n(71297),n(878),n(22836),n(50172),n(72043),n(72506)),$=n(54021),Q=(n(62517),n(69400)),z=n(66608),H=n(40400);const Y=(0,n(89076).v)(),J=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return(0,i._)([(0,l.Cb)(Y.fields)],t.prototype,"fields",void 0),(0,i._)([(0,l.Cb)(Y.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=(0,i._)([(0,u.j)("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};var V=n(27668),W=n(82733),K=n(12478),X=n(95874),ee=n(23072),te=n(12512),ne=n(14845),ie=n(51211),re=n(10171),oe=n(56481),ae=n(90819),se=n(59659);let le=class extends((0,W.M)(J((0,V.h)((0,X.M)((0,K.Q)(p.Z)))))){constructor(e){if(super(e),this.capabilities=(0,H.MS)(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=Z,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new oe.Z(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const n=G.Z.fromJSON(e);return this.queryFeaturesJSON(n,t)}}}),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=j;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?se.M.fromJSON(t.geometryType):null;const n=t?.name,i=n?e.objectType.properties?.[n]:null;i?(this.hasM=i.hasM??!1,this.hasZ=i.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=e.fieldType;"esriFieldTypeOID"===t&&(t="esriFieldTypeInteger"),this.fields.push(te.Z.fromJSON({name:e.name,type:t,alias:e.alias,defaultValue:null,editable:e.editable,nullable:e.nullable}))})),this.fields.push(te.Z.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(te.Z.fromJSON({name:P,type:"esriFieldTypeInteger",alias:P,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=(0,B.i)((0,H.bU)(se.M.toJSON("polyline")).renderer):this.renderer=(0,B.i)((0,H.bU)(se.M.toJSON("point")).renderer):this.renderer=(0,B.i)((0,H.bU)(se.M.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){(0,ne.YN)(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return(0,re.eZ)(this,e)}createQuery(){return new G.Z({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e),r=ie.Z.fromJSON(await i.executeQuery(n.toJSON(),t?.signal));return r.features.forEach((e=>{e.sourceLayer=this})),r}async queryFeaturesJSON(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(n.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(n.toJSON(),t?.signal)}async queryExtent(e={},t){const n={...e,returnGeometry:!0},{resolvedQuery:i,queryEngine:r}=await this._setupQueryObjects(n),o=await r.executeQueryForExtent(i.toJSON(),t?.signal);let a;return a=null!=o.extent?.xmin&&null!=o.extent?.xmax&&null!=o.extent?.ymin&&null!=o.extent?.ymax?new S.Z(o.extent):new S.Z,{count:o.count,extent:a}}async queryObjectIds(e,t){const n=G.Z.from(e);let i;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(n,this,t);i=this.loadQueryEngine(e)}return i.executeQueryForIds(n.toJSON(),t?.signal)}loadQueryEngine(e){const t=new Q.Z({geometryType:se.M.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new z.q({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:se.M.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new G.Z({where:"1=1",outFields:[Z]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const n=G.Z.from(e),i=n.geometry;let r;if(i&&!i.spatialReference?.isWGS84&&(await(0,b.initializeProjection)(i.spatialReference,C.YU),n.geometry=(0,b.project)(i instanceof g.Z||i instanceof ae.Z?i:i.extent,C.YU)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(n,this,t);r=this.loadQueryEngine(e)}return{resolvedQuery:n,queryEngine:r}}};(0,i._)([(0,l.Cb)()],le.prototype,"capabilities",void 0),(0,i._)([(0,l.Cb)({readOnly:!0})],le.prototype,"defaultPopupTemplate",null),(0,i._)([(0,l.Cb)()],le.prototype,"definitionExpression",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"displayField",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"elevationInfo",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"geometryType",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"geometryFieldName",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"graphType",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"hasM",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"hasZ",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"labelsVisible",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"labelingInfo",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"objectIdField",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"objectType",void 0),(0,i._)([(0,l.Cb)()],le.prototype,"parentCompositeLayer",void 0),(0,i._)([(0,l.Cb)(ee.C_)],le.prototype,"popupEnabled",void 0),(0,i._)([(0,l.Cb)({type:U.Z,json:{name:"popupInfo",write:!0}})],le.prototype,"popupTemplate",void 0),(0,i._)([(0,l.Cb)({types:$.A,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],le.prototype,"renderer",null),(0,i._)([(0,l.Cb)()],le.prototype,"source",void 0),(0,i._)([(0,l.Cb)({json:{read:!1}})],le.prototype,"type",void 0),le=(0,i._)([(0,u.j)("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],le);const ue=le;var he=n(36567);let pe,ce=null;function de(){return pe||(pe=n.e(5672).then(n.bind(n,25672)).then((e=>e.l)).then((({default:e})=>e({locateFile:e=>(0,he.V)(`esri/libs/linkchartlayout/${e}`)}))).then((e=>{!function(e){ce=e}(e)})),pe)}var ye,fe;function me(e,t,n,i,r,o){const a=n.length,s=r.length,l=Float64Array.BYTES_PER_ELEMENT,u=Uint32Array.BYTES_PER_ELEMENT,h=Uint8Array.BYTES_PER_ELEMENT,p=15+a*(h+2*l)+s*(2*u),c=ce._malloc(p);try{const h=c+16-c%16,p=h+a*l,d=p+a*l,y=d+s*u,f=y+s*u,m=()=>[ce.HEAPF64.subarray(h>>3,(h>>3)+a),ce.HEAPF64.subarray(p>>3,(p>>3)+a),ce.HEAPU32.subarray(d>>2,(d>>2)+s),ce.HEAPU32.subarray(y>>2,(y>>2)+s),ce.HEAPU8.subarray(f,f+a)],[g,b,C,T,w]=m();g.set(n),b.set(i),C.set(r),T.set(o),w.set(t);let M=e(a,f,h,p,s,d,y),k=null;if(M){const e=ce.getLayoutLinksTypes(),t=ce.getLayoutLinksVerticesEndIndices(),n=ce.getLayoutLinksVertices(),i=ce.countLayoutLinksVertices();!s||e&&t?i&&!n?M=!1:k={types:new Uint8Array(ce.HEAPU8.subarray(e,e+s)),vertexEndIndex:new Uint32Array(ce.HEAPU32.subarray(t>>2,(t>>2)+s)),vertices:new Float64Array(ce.HEAPF64.subarray(n>>3,(n>>3)+2*i))}:M=!1}const[L,I,E,x,_]=m();return n.set(L),i.set(I),r.set(E),o.set(x),t.set(_),{success:M,links:k}}finally{ce._free(c),ce.cleanupLayout()}}!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"}(ye||(ye={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(fe||(fe={}));var ge,be,Ce,Te,we,Me,ke,Le;!function(e){e.getMinIdealEdgeLength=function(){return ce.getMinIdealEdgeLength()},e.apply=function(e,t,n,i,r,o=2,a=1,s=-1){return me(((e,t,n,i,r,l,u)=>ce.applyForceDirectedLayout(e,t,n,i,r,l,u,o,a,s)),e,t,n,i,r)}}(ge||(ge={})),function(e){e.apply=function(e,t,n,i,r,o=2,a=1,s=-1){return me(((e,t,n,i,r,l,u)=>ce.applyCommunityLayout(e,t,n,i,r,l,u,o,a,s)),e,t,n,i,r)}}(be||(be={})),function(e){e.apply=function(e,t,n,i,r){return me(ce.applySimpleLayout,e,t,n,i,r)}}(Ce||(Ce={})),function(e){e.apply=function(e,t,n,i,r){return me(ce.applyHierarchicalLayout,e,t,n,i,r)}}(Te||(Te={})),function(e){e.apply=function(e,t,n,i,r){return me(ce.applyRadialTreeLayout,e,t,n,i,r)}}(we||(we={})),function(e){e.apply=function(e,t,n,i,r){return me(ce.applySmartTreeLayout,e,t,n,i,r)}}(Me||(Me={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(ke||(ke={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Le||(Le={}));var Ie=n(17176),Ee=n(92484),xe=n(67666);let _e=class extends((0,V.h)((0,X.M)(p.Z))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new r.Z,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new S.Z({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new r.Z,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new o.Z("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const t=new Set;let n=[],i=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new o.Z("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.inclusionModeDefinition?.generateAllSublayers?(n=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((r,o)=>{if(!this._graphTypeLookup.get(o))return a.Z.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(o);this._graphTypeLookup.get(o)instanceof Ee.Z||"strictOrigin"in this._graphTypeLookup.get(o)?t.has(o)||(t.add(o),i.push(this._graphTypeLookup.get(o))):this._graphTypeLookup.get(o)instanceof Ie.Z||"properties"in this._graphTypeLookup.get(o)?t.has(o)||(t.add(o),n.push(this._graphTypeLookup.get(o))):(a.Z.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(o))})):(n=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]);const r=new O({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=n,this.memberRelationshipTypes=i,this.dataManager=r}load(e){return this.addResolvingPromise(new Promise((t=>{(0,L.fetchKnowledgeGraph)(this.url).then((n=>{if(this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof d.Z?e.linkChartLocation:e.linkChartLocation?(0,c.GH)(e.linkChartLocation):null,t&&2===t.coords.length&&0===t.lengths.length?(this.linkChartGeohashLookup.set(e.id,(0,h.fC)(t.coords[1],t.coords[0],q)),this.entityLinkChartDiagramLookup.set(e.id,t)):(this.linkChartGeohashLookup.set(e.id,""),this.relationshipLinkChartDiagramLookup.set(e.id,t))})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{(0,s.k_)(e);const t=[],n=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null)}))})))})),this.tables.forEach((e=>{n.push(e.refreshCachedQueryEngine())})),await Promise.all(n)})))}t(null)}))}))),Promise.resolve(this)}async addRecords(e,t){let n=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(n=await async function(e,t){const n=[],i=new Map,r=[];if(t.dataModel?.relationshipTypes)for(const e of t.dataModel.relationshipTypes)e.name&&i.set(e.name,[]);for(const t of e)i.has(t.typeName)&&i.get(t.typeName)?.push(t.id);for(const[e,o]of i){if(o.length<1)continue;const i=new I.Z({openCypherQuery:`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:o}});r.push((0,L.executeQueryStreaming)(t,i).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:i}=await t.read();if(e)break;for(const e of i)n.push({id:e[0],typeName:e[1]}),n.push({id:e[2],typeName:e[3]})}})))}return await Promise.all(r),n}(e,this.dataManager.knowledgeGraph));const i=e.concat(n).filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));await this._handleNewRecords(i)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:n=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let i=[];for(const t of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.members?.has(t.id)&&i.push(t);if(t){const e=new Set,t=[];for(const t of i)if(this.dataManager.nodeConnectionsLookup.has(t.id))for(const n of this.dataManager.nodeConnectionsLookup.get(t.id))e.add(n);for(const n of e)if(this.dataManager.memberIdTypeLookup.has(n))for(const e of this.dataManager.memberIdTypeLookup.get(n))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:n,typeName:e});i=i.concat(t)}this.dataManager.removeFromLayer(i);for(const e of i)this.sublayerIdsCache.get(e.typeName)?.delete(e.id),this.dataManager.relationshipTypeNames.has(e.typeName)?this.relationshipLinkChartDiagramLookup.delete(e.id):this.entityLinkChartDiagramLookup.delete(e.id);n&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{});const r=[];return this.layers.forEach((e=>{r.push(e.refreshCachedQueryEngine())})),await Promise.all(r),this._refreshNamedTypes(),i}async expand(e,t){const n=await this.dataManager.getConnectedRecordIds(e,t),i=n.filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));return await this._handleNewRecords(n),{records:i}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach((e=>{const t=new ue({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberEntityTypes.forEach((e=>{const t=new ue({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{const n=((e,t,n)=>(e.has(t)||e.set(t,n()),e.get(t)))(this.sublayerIdsCache,t,(()=>new Set));e.members?.forEach((e=>{if(n.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof d.Z)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,(0,h.fC)(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],q)):this.linkChartGeohashLookup.set(e.id,"");else{const n=(0,c.GH)(e.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation?n:null):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation?n:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,(0,h.fC)(e.linkChartLocation.x,e.linkChartLocation.y,q)):this.linkChartGeohashLookup.set(e.id,"")}}))}))}async calculateLinkChartLayout(e="RADIAL_TREE",t){const n=[],i=[],r=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{n.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{i.push({typeName:t,feature:e})}))})),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const s=new Map,l=new Map,u=new Map,p=new Map,d=new Uint8Array(n.length),y=new Float64Array(n.length),f=new Float64Array(n.length),m=new Uint32Array(i.length),g=new Uint32Array(i.length),b=[],C=new S.Z({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let T,w="FORCE_DIRECTED",M=0,k=0;switch(w="GEOGRAPHIC"===e?"FORCE_DIRECTED":e,w){case"FORCE_DIRECTED":T=ge.apply;break;case"COMMUNITY":T=be.apply;break;case"HIERARCHICAL":T=Te.apply;break;case"RADIAL_TREE":T=we.apply;break;case"SMART_TREE":T=Me.apply;break;default:T=Ce.apply}n.forEach((({typeName:n,feature:i})=>{if(t?.lockedNodeLocations?.has(i.attributes[Z])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(n)?d[M]=ye.IsGeographic:d[M]=ye.None;const r=t.lockedNodeLocations.get(i.attributes[Z]);y[M]=r.x,f[M]=r.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(n)){d[M]=ye.IsGeographic;let e=null;const t=i.attributes[this.dataManager.geographicLookup.get(n).name],r=this.dataManager.geographicLookup.get(n)?.geometryType;switch(r){case"esriGeometryPoint":y[M]=t?.x,f[M]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(y[M]=e.x,f[M]=e.y):d[M]=ye.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(y[M]=e.x,f[M]=e.y):d[M]=ye.IsMovable;break;default:d[M]=ye.IsMovable}(null==y[M]||null==f[M]||Number.isNaN(y[M])||Number.isNaN(f[M]))&&(d[M]=ye.IsMovable,y[M]=0,f[M]=0)}else d[M]=ye.IsMovable,y[M]=0,f[M]=0;p.set(i.attributes[Z],M),b[M]={feature:i,typeName:n},M++}));let L=!1;const I=new Map;i.forEach((e=>{const t=e.feature.attributes[A],n=e.feature.attributes[F],i=p.get(t),o=p.get(n);if(void 0!==i&&void 0!==o){const a=t+"-"+n,s=I.get(a),l=s?.has(e.typeName);l||(m[k]=i,g[k]=o,void 0===s?I.set(a,new Map([[e.typeName,k]])):s.set(e.typeName,k),k++),r.push(e)}else L=!0,this.relationshipLinkChartDiagramLookup.set(t,null),this.linkChartGeohashLookup.set(t,null)})),L&&a.Z.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await de();const{success:E,links:x}=T(d,y,f,m.subarray(0,k),g.subarray(0,k));if(!E)throw new o.Z("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let e=0;e<b.length;e++){if(f[e]>84.9999?f[e]=84.9999:f[e]<-84.9999&&(f[e]=-84.9999),y[e]>179.9999?y[e]=179.9999:y[e]<-179.9999&&(y[e]=-179.9999),b[e].feature.attributes[j]=new xe.Z(y[e],f[e]),s.has(b[e].typeName)){const t=s.get(b[e].typeName);t?.set(b[e].feature.attributes[Z],b[e].feature)}else{const t=new Map;t.set(b[e].feature.attributes[Z],b[e].feature),s.set(b[e].typeName,t)}u.set(b[e].feature.attributes[Z],b[e].feature);const t=(0,c.GH)(b[e].feature.attributes[j]);this.entityLinkChartDiagramLookup.set(b[e].feature.attributes[Z],b[e].feature.attributes[j]?t:null),this.linkChartGeohashLookup.set(b[e].feature.attributes[Z],(0,h.fC)(b[e].feature.attributes[j].y,b[e].feature.attributes[j].x,q)),b[e].feature.attributes[j].x<C.xmin&&(C.xmin=b[e].feature.attributes[j].x),b[e].feature.attributes[j].x>C.xmax&&(C.xmax=b[e].feature.attributes[j].x),b[e].feature.attributes[j].y<C.ymin&&(C.ymin=b[e].feature.attributes[j].y),b[e].feature.attributes[j].y>C.ymax&&(C.ymax=b[e].feature.attributes[j].y)}if(this.linkChartExtent.xmin=C.xmin,this.linkChartExtent.xmax=C.xmax,this.linkChartExtent.ymin=C.ymin,this.linkChartExtent.ymax=C.ymax,!x)throw new o.Z("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const _=new Map,N=new Map,D=new Map,v=new Set;for(let e=0;e<r.length;e++){const t=[],n=r[e],i=n.feature.attributes[A],o=n.feature.attributes[F],s=i+"-"+o,h=I.get(s).get(n.typeName),d=0===h?0:x?.vertexEndIndex[h-1];if(!v.has(h)){if(v.add(h),x.types[h]===fe.Recursive){const e=[x.vertices[2*d],x.vertices[2*d+1]],n=[x.vertices[2*(d+1)],x.vertices[2*(d+1)+1]],i=[.5*(e[0]+n[0]),.5*(e[1]+n[1])],r=[i[0]-e[0],i[1]-e[1]],o=[i[0]+r[1],i[1]-r[0]],a=[i[0]-r[1],i[1]+r[0]];t.push(e),t.push(o),t.push(n),t.push(a),t.push(e)}else{if(x.types[h]!==fe.Regular){a.Z.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let e=d;e<x.vertexEndIndex[h];e++)t.push([x.vertices[2*e],x.vertices[2*e+1]])}const e=b[p.get(i)]?.feature.attributes[j],n=b[p.get(o)]?.feature.attributes[j];t[0][0]===e.x&&t[0][1]===e.y||(t[0]=[e.x,e.y]),t[t.length-1][0]===n.x&&t[t.length-1][1]===n.y||(t[t.length-1]=[n.x,n.y]);for(let e=1;e<t.length-1;e++)t[e][1]>85.5?t[e][1]=85.5:t[e][1]<-85.5&&(t[e][1]=-85.5),t[e][0]>179.9999?t[e][0]=179.9999:t[e][0]<-179.9999&&(t[e][0]=-179.9999);_.has(s)?_.get(s).push(t):_.set(s,[t])}const y=_.get(s);N.has(s)||(N.set(s,new Map),D.set(s,new Map));const f=N.get(s),m=D.get(s);f.has(n.typeName)||(f.set(n.typeName,y.shift()),m.set(n.typeName,0));const g=f.get(n.typeName);m.set(n.typeName,m.get(n.typeName)+1);const C=new ae.Z({paths:g});if(n.feature.attributes[j]=C,l.has(n.typeName)){const e=l.get(n.typeName);e?.set(n.feature.attributes[Z],n.feature)}else{const e=new Map;e.set(n.feature.attributes[Z],n.feature),l.set(n.typeName,e)}u.set(n.feature.attributes[Z],n.feature);const T=(0,c.GH)(n.feature.attributes[j]);this.relationshipLinkChartDiagramLookup.set(n.feature.attributes[Z],n.feature.attributes[j]?T:null),this.linkChartGeohashLookup.set(n.feature.attributes[Z],"")}for(const e of r)e.feature.attributes[P]=D.get(e.feature.attributes[A]+"-"+e.feature.attributes[F])?.get(e.typeName)??null;return this._currentLinkChartConfig={layoutMode:e},{nodes:s,links:l,idMap:u}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const n=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine())})),await Promise.all(n),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const n=t.linkChartLocation;let i;const r=t.id;n&&(i="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]},e.set(r,new xe.Z({x:i.x,y:i.y})))}))})),e}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const n=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(e.members.keys()).filter((e=>!n.has(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine())})),await Promise.all(t),this._refreshNamedTypes()}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const n of e)this.sublayerIdsCache.has(n.typeName)||(this.sublayerIdsCache.set(n.typeName,new Set),t.push(n.typeName)),this.sublayerIdsCache.get(n.typeName).add(n.id);for(const e of t)if(this._graphTypeLookup.has(e)){const t=this._graphTypeLookup.get(e),n="endPoints"in t?"relationship":"entity",i=new ue({objectType:t,parentCompositeLayer:this,graphType:n,title:e});"entity"===n?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),i.geometryType?this.layers.push(i):this.tables.push(i),this.dataManager.sublayerCaches.set(e,new Map)}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode)}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e?.members?.forEach((e=>{const n=e.linkChartLocation;let i;const r=e.id;if(!n)return;i="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]};const o=(0,c.GH)(i);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(r,o):this.entityLinkChartDiagramLookup.set(r,o),this.linkChartGeohashLookup.set(r,(0,h.fC)(i.x,i.y,q)),this.linkChartExtent.xmin>i.x&&(this.linkChartExtent.xmin=i.x),this.linkChartExtent.xmax<i.x&&(this.linkChartExtent.xmax=i.x),this.linkChartExtent.ymin>i.y&&(this.linkChartExtent.ymin=i.y),this.linkChartExtent.ymax<i.y&&(this.linkChartExtent.ymax=i.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.relationshipLinkChartDiagramLookup.get(e.attributes[A]),n=this.relationshipLinkChartDiagramLookup.get(e.attributes[F]);if(t&&n){const i=(0,c.GH)(new ae.Z({paths:[[t.coords[0],t.coords[1]],[n.coords[0],n.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[Z],i)}else this.relationshipLinkChartDiagramLookup.set(e.attributes[Z],null);this.linkChartGeohashLookup.set(e.attributes[Z],"")}))}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};(0,i._)([(0,l.Cb)()],_e.prototype,"dataPreloadedInLocalCache",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"defaultLinkChartConfig",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"dataManager",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"knowledgeGraph",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"layers",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"entityLinkChartDiagramLookup",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"linkChartExtent",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"linkChartGeohashLookup",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"memberEntityTypes",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"memberRelationshipTypes",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"sublayerIdsCache",void 0),(0,i._)([(0,l.Cb)()],_e.prototype,"tables",void 0),(0,i._)([(0,l.Cb)({json:{read:!1}})],_e.prototype,"type",void 0),_e=(0,i._)([(0,u.j)("esri.layers.LinkChartLayer")],_e);const Ne=_e},69400:function(e,t,n){n.d(t,{Z:function(){return y}});var i=n(7753),r=n(70375),o=n(31355),a=n(13802),s=n(37116),l=n(24568),u=n(12065),h=n(117),p=n(28098),c=n(12102);const d=(0,s.Ue)();class y{constructor(e){this.geometryInfo=e,this._boundsStore=new h.H,this._featuresById=new Map,this._markedIds=new Set,this.events=new o.Z,this.featureAdapter=c.n}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,n,i,r]=this.fullBounds;return{xmin:t,ymin:n,xmax:i,ymax:r,spatialReference:(0,p.S2)(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(e){const t=e.map((e=>this._upsert(e)));return this._emitChanged(),t.filter(i.pC)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const n of e){const e=this._boundsStore.get(n.objectId);e&&t((0,s.JR)(d,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let e=!1;this._featuresById.forEach(((t,n)=>{this._markedIds.has(n)||(e=!0,this._remove(t))})),this._markedIds.clear(),e&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const t=e.objectId;if(null==t)return void a.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new r.Z("featurestore:invalid-feature","feature id is missing",{feature:e}));const n=this._featuresById.get(t);let i;if(this._markedIds.add(t),n?(e.displayId=n.displayId,i=this._boundsStore.get(t),this._boundsStore.delete(t)):null!=this.onFeatureAdd&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(t,null),void this._featuresById.set(t,e);i=(0,u.$)(null!=i?i:(0,l.Ue)(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=i&&this._boundsStore.set(t,i),this._featuresById.set(t,e)}_upsert(e){const t=e?.objectId;if(null==t)return a.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new r.Z("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const n=this._featuresById.get(t);if(!n)return this._add(e),e;this._markedIds.add(t);const{geometry:i,attributes:o}=e;for(const e in o)n.attributes[e]=o[e];return i&&(n.geometry=i,this._boundsStore.set(t,(0,u.$)((0,l.Ue)(),i,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),n}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._markedIds.delete(t),this._boundsStore.delete(t),this._featuresById.delete(t),e}}},12065:function(e,t,n){n.d(t,{$:function(){return ie},$g:function(){return re},EI:function(){return Q},GH:function(){return z},IN:function(){return w},Iv:function(){return S},J6:function(){return A},Jd:function(){return T},Nh:function(){return X},RZ:function(){return K},Uy:function(){return P},XA:function(){return B},Yn:function(){return $},cn:function(){return J},dd:function(){return G},di:function(){return H},eG:function(){return j},fQ:function(){return k},hY:function(){return oe},h_:function(){return V},ks:function(){return q},lM:function(){return W},lz:function(){return se},zj:function(){return ee}});var i=n(70375),r=n(13802),o=n(61681),a=n(37116),s=n(24568),l=n(53736),u=n(59958),h=n(61619),p=n(15540);function c(e,t){return e?t?4:3:t?3:2}const d=()=>r.Z.getLogger("esri.layers.graphics.featureConversionUtils"),y={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryEnvelope:0},f=(e,t,n,i,r,o)=>{e[n]=r,e[n+1]=o},m=(e,t,n,i,r,o)=>{e[n]=r,e[n+1]=o,e[n+2]=t[i+2]},g=(e,t,n,i,r,o)=>{e[n]=r,e[n+1]=o,e[n+2]=t[i+3]},b=(e,t,n,i,r,o)=>{e[n]=r,e[n+1]=o,e[n+2]=t[i+2],e[n+3]=t[i+3]};function C(e,t,n,i){if(e){if(n)return t&&i?b:m;if(t&&i)return g}else if(t&&i)return m;return f}function T({scale:e,translate:t},n){return Math.round((n-t[0])/e[0])}function w({scale:e,translate:t},n){return Math.round((t[1]-n)/e[1])}function M({scale:e,translate:t},n,i){return n*e[i]+t[i]}function k(e,t,n){return e?t?n?D(e):E(e):n?_(e):L(e):null}function L(e){const t=e.coords;return{x:t[0],y:t[1]}}function I(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function E(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function x(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function _(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function N(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function D(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function v(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function R(e,t){return e&&t?v:e?x:t?N:I}function G(e,t,n=R(null!=t.z,null!=t.m)){return n(e,t)}function S(e,t,n){if(null==e)return null;const i=c(t,n),r=[];for(let t=0;t<e.coords.length;t+=i){const n=[];for(let r=0;r<i;r++)n.push(e.coords[t+r]);r.push(n)}return t?n?{points:r,hasZ:t,hasM:n}:{points:r,hasZ:t}:n?{points:r,hasM:n}:{points:r}}function Z(e,t,n=c(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const i=e.coords;let r=0;for(const e of t.points)for(let t=0;t<n;t++)i[r++]=e[t];return e}function A(e,t,n){if(!e)return null;const i=c(t,n),{coords:r,lengths:o}=e,a=[];let s=0;for(const e of o){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<i;t++)e.push(r[s++]);t.push(e)}a.push(t)}return t?n?{paths:a,hasZ:t,hasM:n}:{paths:a,hasZ:t}:n?{paths:a,hasM:n}:{paths:a}}function F(e,t,n=c(t.hasZ,t.hasM)){const{lengths:i,coords:r}=e;let o=0;for(const e of t.paths){for(const t of e)for(let e=0;e<n;e++)r[o++]=t[e];i.push(e.length)}return e}function j(e,t,n){if(!e)return null;const i=c(t,n),{coords:r,lengths:o}=e,a=[];let s=0;for(const e of o){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<i;t++)e.push(r[s++]);t.push(e)}a.push(t)}return t?n?{rings:a,hasZ:t,hasM:n}:{rings:a,hasZ:t}:n?{rings:a,hasM:n}:{rings:a}}function P(e,t,n=t.hasZ,i=t.hasM){return q(e,t.rings,n,i)}function q(e,t,n,i){const r=c(n,i),{lengths:o,coords:a}=e;let s=0;le(e);for(const e of t){for(const t of e)for(let e=0;e<r;e++)a[s++]=t[e];o.push(e.length)}return e}const O=[],U=[];function B(e,t,n,i,r){O[0]=e;const[o]=$(U,O,t,n,i,r);return ue(O),ue(U),o}function $(e,t,n,r,o,a){if(ue(e),!n){for(const n of t){const t=a?n.attributes[a]:void 0;e.push(new u.u_(null,n.attributes,null,t))}return e}switch(n){case"esriGeometryPoint":return function(e,t,n,i,r){const o=R(n,i);for(const{geometry:n,attributes:i}of t){const t=null!=n?o(new p.Z,n):null;e.push(new u.u_(t,i,null,r?i[r]:void 0))}return e}(e,t,r,o,a);case"esriGeometryMultipoint":return function(e,t,n,i,r){const o=c(n,i);for(const{geometry:n,attributes:i}of t){const t=null!=n?Z(new p.Z,n,o):null;e.push(new u.u_(t,i,null,r?i[r]:void 0))}return e}(e,t,r,o,a);case"esriGeometryPolyline":return function(e,t,n,i,r){const o=c(n,i);for(const{geometry:n,attributes:i,centroid:a}of t){const t=null!=n?F(new p.Z,n,o):null,s=null!=a?G(new p.Z,a):null;e.push(new u.u_(t,i,s,r?i[r]:void 0))}return e}(e,t,r,o,a);case"esriGeometryPolygon":return function(e,t,n,i,r){for(const{geometry:o,centroid:a,attributes:s}of t){const t=null!=o?P(new p.Z,o,n,i):null,l=r?s[r]:void 0;null!=a?e.push(new u.u_(t,s,I(new p.Z,a),l)):e.push(new u.u_(t,s,null,l))}return e}(e,t,r,o,a);default:d().error("convertToFeatureSet:unknown-geometry",new i.Z(`Unable to parse unknown geometry type '${n}'`)),ue(e)}return e}function Q(e,t,n,i){U[0]=e,Y(O,U,t,n,i);const r=O[0];return ue(O),ue(U),r}function z(e,t,n){if(null==e)return null;const r=new p.Z;return"hasZ"in e&&null==t&&(t=e.hasZ),"hasM"in e&&null==n&&(n=e.hasM),(0,l.wp)(e)?R(null!=t?t:null!=e.z,null!=n?n:null!=e.m)(r,e):(0,l.oU)(e)?P(r,e,t,n):(0,l.l9)(e)?F(r,e,c(t,n)):(0,l.aW)(e)?Z(r,e,c(t,n)):void d().error("convertFromGeometry:unknown-geometry",new i.Z(`Unable to parse unknown geometry type '${e}'`))}function H(e,t,n,r){const o=e&&("coords"in e?e:e.geometry);if(null==o)return null;switch(t){case"esriGeometryPoint":{let e=L;return n&&r?e=D:n?e=E:r&&(e=_),e(o)}case"esriGeometryMultipoint":return S(o,n,r);case"esriGeometryPolyline":return A(o,n,r);case"esriGeometryPolygon":return j(o,n,r);default:return d().error("convertToGeometry:unknown-geometry",new i.Z(`Unable to parse unknown geometry type '${t}'`)),null}}function Y(e,t,n,r,o){if(ue(e),null==n)return function(e,t){for(const n of t)e.push({attributes:n.attributes});return e}(e,t);switch(n){case"esriGeometryPoint":return function(e,t,n,i){let r=L;n&&i?r=D:n?r=E:i&&(r=_);for(const n of t){const{geometry:t,attributes:i}=n,o=null!=t?r(t):null;e.push({attributes:i,geometry:o})}return e}(e,t,r,o);case"esriGeometryMultipoint":return function(e,t,n,i){for(const{geometry:r,attributes:o}of t)e.push({attributes:o,geometry:null!=r?S(r,n,i):null});return e}(e,t,r,o);case"esriGeometryPolyline":return function(e,t,n,i){for(const{geometry:r,attributes:o}of t)e.push({attributes:o,geometry:null!=r?A(r,n,i):null});return e}(e,t,r,o);case"esriGeometryPolygon":return function(e,t,n,i){for(const{geometry:r,attributes:o,centroid:a}of t){const t=null!=r?j(r,n,i):null;if(null!=a){const n=L(a);e.push({attributes:o,centroid:n,geometry:t})}else e.push({attributes:o,geometry:t})}return e}(e,t,r,o);default:d().error("convertToFeatureSet:unknown-geometry",new i.Z(`Unable to parse unknown geometry type '${n}'`))}return e}function J(e){const{objectIdFieldName:t,spatialReference:n,transform:i,fields:r,hasM:o,hasZ:a,features:s,geometryType:l,exceededTransferLimit:u,uniqueIdField:h,queryGeometry:p,queryGeometryType:c}=e,d={features:Y([],s,l,a,o),fields:r,geometryType:l,objectIdFieldName:t,spatialReference:n,uniqueIdField:h,queryGeometry:H(p,c,!1,!1)};return i&&(d.transform=i),u&&(d.exceededTransferLimit=u),o&&(d.hasM=o),a&&(d.hasZ=a),d}function V(e,t){const n=new h.Z,{hasM:r,hasZ:o,features:a,objectIdFieldName:s,spatialReference:l,geometryType:u,exceededTransferLimit:p,transform:c,fields:y}=e;return y&&(n.fields=y),n.geometryType=u??null,n.objectIdFieldName=s??t??null,n.spatialReference=l??null,n.objectIdFieldName?(a&&$(n.features,a,u,o,r,n.objectIdFieldName),p&&(n.exceededTransferLimit=p),r&&(n.hasM=r),o&&(n.hasZ=o),c&&(n.transform=c),n):(d().error(new i.Z("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)}function W(e){const{transform:t,features:n,hasM:i,hasZ:r}=e;if(!t)return e;for(const e of n)null!=e.geometry&&re(e.geometry,e.geometry,i,r,t),null!=e.centroid&&re(e.centroid,e.centroid,i,r,t);return e.transform=null,e}function K(e,t){const{geometryType:n,features:i,hasM:r,hasZ:o}=t;if(!e)return t;for(let t=0;t<i.length;t++){const a=i[t],s=a.weakClone();s.geometry=new p.Z,X(s.geometry,a.geometry,r,o,n,e),a.centroid&&(s.centroid=new p.Z,X(s.centroid,a.centroid,r,o,"esriGeometryPoint",e)),i[t]=s}return t.transform=e,t}function X(e,t,n,i,r,o,a=n,s=i){if(le(e),!t?.coords.length)return null;const l=y[r],{coords:u,lengths:h}=t,p=c(n,i),d=c(n&&a,i&&s),f=C(n,i,a,s);if(!h.length)return f(e.coords,u,0,0,T(o,u[0]),w(o,u[1])),le(e,p,0),e;let m,g,b,M,k=0,L=0,I=L;for(const t of h){if(t<l)continue;let n=0;L=I,b=m=T(o,u[k]),M=g=w(o,u[k+1]),f(e.coords,u,L,k,b,M),n++,k+=p,L+=d;for(let i=1;i<t;i++,k+=p)b=T(o,u[k]),M=w(o,u[k+1]),b===m&&M===g||(f(e.coords,u,L,k,b-m,M-g),L+=d,n++,m=b,g=M);n>=l&&(e.lengths.push(n),I=L)}return ue(e.coords,I),e.coords.length?e:null}function ee(e,t,n,i,r,o,a=n,s=i){if(le(e),!t?.coords.length)return null;const l=y[r],{coords:u,lengths:h}=t,p=c(n,i),d=c(n&&a,i&&s),f=C(n,i,a,s);if(!h.length)return f(e.coords,u,0,0,u[0],u[1]),le(e,p,0),e;let m=0;const g=o*o;for(const t of h){if(t<l){m+=t*p;continue}const n=e.coords.length/d,i=m,r=m+(t-1)*p;f(e.coords,u,e.coords.length,i,u[i],u[i+1]),ne(e.coords,u,p,g,f,i,r),f(e.coords,u,e.coords.length,r,u[r],u[r+1]);const o=e.coords.length/d-n;o>=l?e.lengths.push(o):ue(e.coords,n*d),m+=t*p}return e.coords.length?e:null}function te(e,t,n,i){const r=e[t],o=e[t+1],a=e[n],s=e[n+1],l=e[i],u=e[i+1];let h=a,p=s,c=l-h,d=u-p;if(0!==c||0!==d){const e=((r-h)*c+(o-p)*d)/(c*c+d*d);e>1?(h=l,p=u):e>0&&(h+=c*e,p+=d*e)}return c=r-h,d=o-p,c*c+d*d}function ne(e,t,n,i,r,o,a){let s,l=i,u=0;for(let e=o+n;e<a;e+=n)s=te(t,e,o,a),s>l&&(u=e,l=s);l>i&&(u-o>n&&ne(e,t,n,i,r,o,u),r(e,t,e.length,u,t[u],t[u+1]),a-u>n&&ne(e,t,n,i,r,u,a))}function ie(e,t,n,i){if(!t?.coords?.length)return null;const r=c(n,i);let o=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=r){const n=e[t],i=e[t+1];o=Math.min(o,n),u=Math.max(u,n),l=Math.min(l,i),h=Math.max(h,i)}}return(0,a.is)(e)?(0,a.bZ)(e,o,l,u,h):(0,s.al)(o,l,u,h,e),e}function re(e,t,n,i,r){const{coords:a,lengths:s}=t,l=c(n,i);if(!a.length)return e!==t&&le(e),e;(0,o.O3)(r);const{originPosition:u,scale:h,translate:p}=r,d=he;d.originPosition=u;const y=d.scale;y[0]=h[0]??1,y[1]=-(h[1]??1),y[2]=h[2]??1,y[3]=h[3]??1;const f=d.translate;if(f[0]=p[0]??0,f[1]=p[1]??0,f[2]=p[2]??0,f[3]=p[3]??0,!s.length){for(let t=0;t<l;++t)e.coords[t]=M(d,a[t],t);return e!==t&&le(e,l,0),e}let m=0;for(let t=0;t<s.length;t++){const n=s[t];e.lengths[t]=n;for(let t=0;t<l;++t)e.coords[m+t]=M(d,a[m+t],t);let i=e.coords[m],r=e.coords[m+1];m+=l;for(let t=1;t<n;t++,m+=l){i+=a[m]*y[0],r+=a[m+1]*y[1],e.coords[m]=i,e.coords[m+1]=r;for(let t=2;t<l;++t)e.coords[m+t]=M(d,a[m+t],t)}}return e!==t&&le(e,a.length,s.length),e}function oe(e,t,n,i,r,o){if(le(e),e.lengths.push(...t.lengths),n===r&&i===o)for(let n=0;n<t.coords.length;n++)e.coords.push(t.coords[n]);else{const a=c(n,i),s=C(n,i,r,o),l=t.coords;for(let t=0;t<l.length;t+=a)s(e.coords,l,e.coords.length,t,l[t],l[t+1])}return e}function ae(e,t,n,i){let r=0,o=e[i*t],a=e[i*(t+1)];for(let s=1;s<n;s++){const n=o+e[i*(t+s)],l=a+e[i*(t+s)+1],u=(n-o)*(l+a);o=n,a=l,r+=u}return.5*r}function se(e,t){const{coords:n,lengths:i}=e;let r=0,o=0;for(let e=0;e<i.length;e++){const a=i[e];o+=ae(n,r,a,t),r+=a}return Math.abs(o)}function le(e,t=0,n=0){ue(e.lengths,n),ue(e.coords,t)}function ue(e,t=0){e.length!==t&&(e.length=t)}const he={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]}},40400:function(e,t,n){n.d(t,{Dm:function(){return h},Hq:function(){return p},MS:function(){return c},bU:function(){return s}});var i=n(39994),r=n(67134),o=n(10287),a=n(86094);function s(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?a.I4:"esriGeometryPolyline"===e?a.ET:a.lF}}}const l=/^[_$a-zA-Z][_$a-zA-Z0-9]*$/;let u=1;function h(e,t){if((0,i.Z)("esri-csp-restrictions"))return()=>({[t]:null,...e});try{let n=`this.${t} = null;`;for(const t in e)n+=`this${l.test(t)?`.${t}`:`["${t}"]`} = ${JSON.stringify(e[t])};`;const i=new Function(`\n      return class AttributesClass$${u++} {\n        constructor() {\n          ${n};\n        }\n      }\n    `)();return()=>new i}catch(n){return()=>({[t]:null,...e})}}function p(e={}){return[{name:"New Feature",description:"",prototype:{attributes:(0,r.d9)(e)}}]}function c(e,t){return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:t,supportsDelete:t,supportsEditing:t,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:t,supportsExceedsLimitStatistics:!0,supportsAsyncConvert3D:!1},query:o.g,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsGeometryUpdate:t,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}},99606:function(e,t,n){n.d(t,{Z:function(){return u}});var i=n(36663),r=(n(91957),n(81977)),o=(n(39994),n(13802),n(4157),n(40266)),a=n(63055),s=n(67666);let l=class extends a.Z{constructor(e){super(e),this.layoutGeometry=null}};(0,i._)([(0,r.Cb)({type:s.Z,json:{write:!0}})],l.prototype,"layoutGeometry",void 0),l=(0,i._)([(0,o.j)("esri.rest.knowledgeGraph.Entity")],l);const u=l},63055:function(e,t,n){n.d(t,{Z:function(){return l}});var i=n(36663),r=n(81977),o=(n(39994),n(13802),n(4157),n(40266)),a=n(60915);let s=class extends a.Z{constructor(e){super(e),this.typeName=null,this.id=null}};(0,i._)([(0,r.Cb)({type:String,json:{write:!0}})],s.prototype,"typeName",void 0),(0,i._)([(0,r.Cb)({type:String,json:{write:!0}})],s.prototype,"id",void 0),s=(0,i._)([(0,o.j)("esri.rest.knowledgeGraph.GraphNamedObject")],s);const l=s},60915:function(e,t,n){n.d(t,{Z:function(){return l}});var i=n(36663),r=n(82064),o=n(81977),a=(n(39994),n(13802),n(4157),n(40266));let s=class extends r.wq{constructor(e){super(e),this.properties=null}};(0,i._)([(0,o.Cb)({json:{write:!0}})],s.prototype,"properties",void 0),s=(0,i._)([(0,a.j)("esri.rest.knowledgeGraph.GraphObject")],s);const l=s},76512:function(e,t,n){n.d(t,{Z:function(){return h}});var i=n(36663),r=n(81977),o=(n(39994),n(13802),n(4157),n(40266)),a=n(74396);let s=class extends a.Z{constructor(e){super(e),this.openCypherQuery=""}};(0,i._)([(0,r.Cb)()],s.prototype,"openCypherQuery",void 0),s=(0,i._)([(0,o.j)("esri.rest.knowledgeGraph.GraphQuery")],s);const l=s;let u=class extends l{constructor(e){super(e),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null,this.outputSpatialReference=null}};(0,i._)([(0,r.Cb)()],u.prototype,"bindParameters",void 0),(0,i._)([(0,r.Cb)()],u.prototype,"bindGeometryQuantizationParameters",void 0),(0,i._)([(0,r.Cb)()],u.prototype,"outputQuantizationParameters",void 0),(0,i._)([(0,r.Cb)()],u.prototype,"outputSpatialReference",void 0),u=(0,i._)([(0,o.j)("esri.rest.knowledgeGraph.GraphQueryStreaming")],u);const h=u},29197:function(e,t,n){n.d(t,{Z:function(){return s}});var i=n(36663),r=(n(13802),n(39994),n(4157),n(70375),n(40266)),o=n(60915);let a=class extends o.Z{constructor(e){super(e)}};a=(0,i._)([(0,r.j)("esri.rest.knowledgeGraph.ObjectValue")],a);const s=a},78755:function(e,t,n){n.d(t,{Z:function(){return u}});var i=n(36663),r=n(82064),o=n(81977),a=(n(39994),n(13802),n(4157),n(40266)),s=n(60915);let l=class extends r.wq{constructor(e){super(e),this.path=null}};(0,i._)([(0,o.Cb)({type:[s.Z],json:{write:!0}})],l.prototype,"path",void 0),l=(0,i._)([(0,a.j)("esri.rest.knowledgeGraph.Path")],l);const u=l},70206:function(e,t,n){n.d(t,{Z:function(){return u}});var i=n(36663),r=(n(91957),n(81977)),o=(n(39994),n(13802),n(4157),n(40266)),a=n(63055),s=n(90819);let l=class extends a.Z{constructor(e){super(e),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};(0,i._)([(0,r.Cb)({type:String,json:{write:!0}})],l.prototype,"originId",void 0),(0,i._)([(0,r.Cb)({type:String,json:{write:!0}})],l.prototype,"destinationId",void 0),(0,i._)([(0,r.Cb)({type:s.Z,json:{write:!0}})],l.prototype,"layoutGeometry",void 0),l=(0,i._)([(0,o.j)("esri.rest.Relationship.Relationship")],l);const u=l}}]);